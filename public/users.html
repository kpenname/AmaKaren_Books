<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Users list</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" type="text/css"/>
  <script src="js/jquery-3.5.1.min.js" type="application/javascript"></script>
</head>
<body>
    <h1>List of users in Book Club</h1>
    <div id="div_map" class="row">
        <h2 id="dist"></h2>
        <div id="map"></div>
    </div>
    <br/>
    <div>
    <table id="tableData" class="row">
        <thead>
          <tr>
              <td>First name</td>
              <td>Last name</td>
              <td>Post code</td>
          </tr>
        </thead>
        <tbody class="tbody">
        </tbody>
    </table>
</div>
    
</body>
<script type="application/javascript">
    mapboxgl.accessToken =
'pk.eyJ1IjoiYW1ha2FvYmVoaSIsImEiOiJja2EyaW9nZnEwNHNpM2VtcmVnbTl0NjlkIn0.u28j7D3OeLUuDaKyanGMFQ';

        $(document).ready(() => {
            let map = null;
            let markers = []; 
            map = new mapboxgl.Map({
		        container: 'map',
		        style: 'mapbox://styles/amakaobehi/cka2jl4s00a0m1iojjo7pxv4z',
		        center: [-75.765, 45.4553],
		        //center: [8.970084,7.4922416],
		        zoom: 13,
            });   
            var ottawaLat = 45.319212;
            var ottawaLng = -75.6691652;
            markers.push(new mapboxgl.Marker().setLngLat([ottawaLng, ottawaLat]).addTo(map));
            $.ajax({
                url: "http://localhost:9000/users", 
                method: 'GET',
                success: function(response){
                    console.log(response[0]);
                    console.log(response[0].firstName);
                    console.log(response[0].lastName);
                    console.log(response[0].postCode);
                    console.log(response[0].address);
                    
                    if(response.length > 0){
                        for(let index = 0; index < response.length; index++) {
                            var newRow = $("<tr>");
                            var cols = "";
                            var firstname = '';
                            var lastname = '';
                            var postcode = response[index].postCode;
                            $.ajax({
                                url: "http://localhost:9000/geocoding?postcode=" + response[index].postCode,
                                method: 'GET',
                                success: function(response2){
                                     console.log(response2.latt);   
                                     console.log(response2.longt); 
                                     const marker = new mapboxgl.Marker().setLngLat([response2.longt, response2.latt]).addTo(map);
                                     markers.push(marker);  
                                }
                            });
                            cols += '<td> '+ response[index].firstName +'</td>';
                            cols += '<td> '+ response[index].lastName +'</td>';
                            cols += '<td> '+ response[index].postCode+'</td>';                
                            newRow.append(cols);
                            $("#tableData .tbody").append(newRow);
                        }   
                    }
                    
                }
            });
        });
    </script>
</html>